<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Save and Taste - Gemma Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        :root { --primary: #2ecc71; --dark: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; background: var(--bg); color: #2c3e50; }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; font-size: 1.2rem; font-weight: 800; }
        #webcam-container { width: 100%; display: flex; justify-content: center; background: #000; height: 300px; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        canvas { height: 100% !important; width: auto !important; border-radius: 0 0 20px 20px; }
        .info-card { margin: -30px 15px 20px 15px; background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        #label-container { font-size: 1.5rem; color: var(--dark); font-weight: bold; text-align: center; margin-bottom: 20px; min-height: 36px; }
        .btn-ia { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; width: 100%; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 0 var(--dark); }
        .btn-ia:active { transform: translateY(4px); box-shadow: none; }
        .btn-ia:disabled { background: #bdc3c7; box-shadow: 0 4px 0 #95a5a6; opacity: 0.7; }
        #ai-response { margin-top: 25px; line-height: 1.6; font-size: 1rem; background: #f9f9f9; padding: 15px; border-radius: 10px; border: 1px solid #eee; display: none; white-space: pre-wrap; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">SAVE AND TASTE</div>
<div id="webcam-container"></div>

<div class="info-card">
    <div id="label-container">Cargando cámara...</div>
    <button class="btn-ia" id="btn-ia" onclick="preguntarIA()" disabled>✨ ¿Cómo aprovecho este alimento?</button>
    <div id="ai-response"></div>
</div>

<script type="text/javascript">
    // --- AQUÍ PEGAS TUS CLAVES ---
    const URL_MODELO = "https://teachablemachine.withgoogle.com/models/_UsIOfbEQ/"; 
    const HF_TOKEN = "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"; 
    // ----------------------------

    const MODEL_ID = "google/gemma-2-2b-it";
    let model, webcam, labelContainer, currentFood = "";

    async function init() {
        try {
            model = await tmImage.load(URL_MODELO + "model.json", URL_MODELO + "metadata.json");
            webcam = new tmImage.Webcam(400, 400, false);
            await webcam.setup({ facingMode: "environment" }); 
            await webcam.play();
            window.requestAnimationFrame(loop);
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
        } catch (e) {
            document.getElementById("label-container").innerHTML = "⚠️ Error: Activa la cámara";
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let highProb = 0;
        let bestMatch = "";

        for (let i = 0; i < model.getTotalClasses(); i++) {
            if (prediction[i].probability > highProb) {
                highProb = prediction[i].probability;
                bestMatch = prediction[i].className;
            }
        }

        if (highProb > 0.85) {
            currentFood = bestMatch;
            labelContainer.innerHTML = "Detectado: " + currentFood;
            document.getElementById("btn-ia").disabled = false;
        } else {
            labelContainer.innerHTML = "Enfoca un alimento...";
            document.getElementById("btn-ia").disabled = true;
        }
    }

    async function preguntarIA() {
        const responseDiv = document.getElementById("ai-response");
        const btn = document.getElementById("btn-ia");
        
        responseDiv.style.display = "block";
        responseDiv.innerHTML = '<div class="loader"></div> Consultando a Gemma-2...';
        btn.disabled = true;

        const prompt = `<start_of_turn>user
Eres un experto en cocina y sostenibilidad. He detectado: ${currentFood}. 
Dame 3 consejos breves y creativos para aprovecharlo y evitar el desperdicio. 
Usa un lenguaje cercano y educativo.<end_of_turn>
<start_of_turn>model`;

        try {
            const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${HF_TOKEN}`
                },
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: { max_new_tokens: 250, temperature: 0.7 }
                })
            });

            const data = await response.json();
            let textoCompleto = data[0].generated_text;
            let respuestaLimpia = textoCompleto.split("<start_of_turn>model")[1] || textoCompleto;
            responseDiv.innerText = respuestaLimpia.trim();
        } catch (error) {
            responseDiv.innerText = "IA ocupada. Revisa que aceptaste la licencia de Gemma en Hugging Face.";
        } finally {
            btn.disabled = false;
        }
    }

    init();
</script>
</body>
</html>
