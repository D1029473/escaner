<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshScan AI · Conservación Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        :root {
            --primary: #007AFF; --success: #34C759; --warning: #FF9500; --danger: #FF3B30;
            --background: #F5F5F7; --card: #FFFFFF; --text: #1D1D1F; --text-secondary: #86868B;
            --border: #E5E5EA; --radius: 18px; --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        body { background: var(--background); color: var(--text); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
        
        /* Header */
        header { text-align: center; padding: 20px 0; }
        .logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px; }
        .logo i { font-size: 32px; color: var(--primary); }
        .logo h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary), #00C6FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Scanner */
        .scanner-card { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
        .camera-container { position: relative; width: 100%; aspect-ratio: 4/3; border-radius: 16px; overflow: hidden; background: #000; }
        #cameraFeed { width: 100%; height: 100%; object-fit: cover; }
        .scan-box { width: 70%; height: 70%; border: 3px solid var(--primary); border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
        
        /* Controles */
        .controls { display: flex; gap: 16px; margin-top: 20px; }
        .btn { flex: 1; padding: 16px; border-radius: 14px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s ease; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #0056CC; transform: translateY(-2px); }
        .btn-secondary { background: rgba(0, 122, 255, 0.1); color: var(--primary); }
        
        /* Análisis de deterioro */
        .spoil-analysis { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
        .confidence-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin: 16px 0; }
        .confidence-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .spoilage-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px; }
        .detail-card { background: var(--background); padding: 16px; border-radius: 12px; text-align: center; }
        
        /* Alertas */
        .alert { background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 14px; padding: 20px; margin-top: 20px; }
        
        /* Resultados */
        .result-card { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); display: none; }
        .loading { display: none; flex-direction: column; align-items: center; gap: 20px; padding: 40px 0; }
        .spinner { width: 48px; height: 48px; border: 4px solid rgba(0, 122, 255, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { gap: 16px; }
            .controls { flex-direction: column; }
            .spoilage-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><i class="fas fa-leaf"></i><h1>FreshScan AI</h1></div>
            <p class="tagline">Conservación inteligente con análisis de deterioro por IA</p>
        </header>

        <section class="scanner-card">
            <div class="card-header">
                <h2>Escáner de Alimentos</h2>
                <div class="badge fresh" id="statusBadge">
                    <i class="fas fa-check-circle"></i><span>Fresco</span>
                </div>
            </div>
            <div class="camera-container">
                <video id="cameraFeed" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="camera-overlay"><div class="scan-box"></div></div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" id="captureBtn">
                    <i class="fas fa-camera"></i>Analizar Conservación
                </button>
                <button class="btn btn-secondary" id="recipeBtn">
                    <i class="fas fa-utensils"></i>Generar Receta
                </button>
            </div>
        </section>

        <section class="spoil-analysis" id="spoilAnalysis" style="display: none;">
            <div class="spoil-header">
                <h3>Análisis de Deterioro</h3>
                <span class="confidence-text" id="confidenceText">Confianza: 0%</span>
            </div>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceFill" style="width: 0%;"></div>
            </div>
            <div class="spoilage-details">
                <div class="detail-card"><div class="detail-value" id="moldValue">0%</div><div class="detail-label">Moho</div></div>
                <div class="detail-card"><div class="detail-value" id="darkValue">0%</div><div class="detail-label">Zonas oscuras</div></div>
                <div class="detail-card"><div class="detail-value" id="freshValue">100%</div><div class="detail-label">Frescura</div></div>
            </div>
        </section>

        <div class="alert" id="alert" style="display: none;">
            <div class="alert-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Posible deterioro detectado</h3>
            </div>
            <p>El análisis detectó signos de deterioro. ¿Continuar o descartar?</p>
            <div class="alert-buttons">
                <button class="alert-btn alert-confirm" id="proceedBtn">Continuar (con precaución)</button>
                <button class="alert-btn alert-dismiss" id="dismissBtn">Descartar</button>
            </div>
        </div>

        <section class="result-card" id="resultCard">
            <div class="result-header">
                <div class="result-icon"><i class="fas fa-robot"></i></div>
                <div>
                    <h2 id="resultTitle">Consejos de Conservación</h2>
                    <p id="resultSubtitle">Recomendaciones por IA</p>
                </div>
            </div>
            <div class="result-content" id="resultContent"></div>
        </section>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analizando con IA...</p>
        </div>
    </div>

    <script>
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const recipeBtn = document.getElementById('recipeBtn');
        const resultCard = document.getElementById('resultCard');
        const resultContent = document.getElementById('resultContent');
        const loading = document.getElementById('loading');
        const alert = document.getElementById('alert');
        const statusBadge = document.getElementById('statusBadge');
        
        let isSpoiled = false;
        let currentFood = '';
        let currentOption = 'conservation';

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
            } catch (error) {
                console.error('Error cámara:', error);
                video.poster = 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=800&auto=format&fit=crop';
            }
        }

        function analyzeSpoilage(imageData) {
            const data = imageData.data;
            let totalPixels = data.length / 4;
            let moldPixels = 0, darkPixels = 0;
            
            const MOLD_THRESHOLD = 100;
            const DARK_THRESHOLD = 50;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                if (g > MOLD_THRESHOLD && r < g * 0.8 && b < g * 0.8) moldPixels++;
                if (r < DARK_THRESHOLD && g < DARK_THRESHOLD && b < DARK_THRESHOLD) darkPixels++;
            }
            
            const moldPercent = Math.round((moldPixels / totalPixels) * 100);
            const darkPercent = Math.round((darkPixels / totalPixels) * 100);
            const freshPercent = 100 - Math.min(100, moldPercent + darkPercent);
            
            const confidence = Math.min(100, moldPercent * 3 + darkPercent * 2);
            isSpoiled = confidence > 30;
            
            document.getElementById('moldValue').textContent = moldPercent + '%';
            document.getElementById('darkValue').textContent = darkPercent + '%';
            document.getElementById('freshValue').textContent = freshPercent + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';
            document.getElementById('confidenceText').textContent = 'Confianza: ' + confidence + '%';
            
            const fillColor = confidence < 30 ? '#34C759' : confidence < 60 ? '#FF9500' : '#FF3B30';
            document.getElementById('confidenceFill').style.backgroundColor = fillColor;
            
            statusBadge.className = isSpoiled ? 'badge check' : 'badge fresh';
            statusBadge.innerHTML = isSpoiled 
                ? '<i class="fas fa-exclamation-triangle"></i><span>Revisar</span>'
                : '<i class="fas fa-check-circle"></i><span>Fresco</span>';
            
            document.getElementById('spoilAnalysis').style.display = 'block';
            
            return { moldPercent, darkPercent, freshPercent, confidence, isSpoiled };
        }

        async function captureAndAnalyze(option) {
            currentOption = option;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const analysis = analyzeSpoilage(imageData);
            
            if (analysis.isSpoiled) {
                alert.style.display = 'flex';
            } else {
                getFoodNameAndCallAPI();
            }
        }

        async function getFoodNameAndCallAPI() {
            const food = prompt("¿Qué alimento estás escaneando?", "manzana");
            if (!food) return;
            currentFood = food.toLowerCase().trim();
            await callAPI();
        }

        async function callAPI() {
            loading.style.display = 'flex';
            resultCard.style.display = 'none';
            alert.style.display = 'none';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        food: currentFood,
                        option: currentOption,
                        isSpoiled: isSpoiled
                    })
                });
                
                const data = await response.json();
                resultTitle.textContent = currentOption === 'conservation' 
                    ? `Conservación de ${currentFood}` 
                    : `Receta con ${currentFood}`;
                resultSubtitle.textContent = isSpoiled ? '⚠️ Alimento en mal estado' : '✅ Alimento fresco';
                resultContent.textContent = data.response;
                
            } catch (error) {
                resultContent.textContent = `Error: ${error.message}. Por favor, intenta de nuevo.`;
            } finally {
                loading.style.display = 'none';
                resultCard.style.display = 'block';
            }
        }

        captureBtn.addEventListener('click', () => captureAndAnalyze('conservation'));
        recipeBtn.addEventListener('click', () => captureAndAnalyze('recipe'));
        document.getElementById('proceedBtn').addEventListener('click', getFoodNameAndCallAPI);
        document.getElementById('dismissBtn').addEventListener('click', () => {
            alert.style.display = 'none';
            isSpoiled = false;
        });

        initCamera();
    </script>
</body>
</html>
